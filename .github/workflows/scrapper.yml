name: Run Scraper on EC2 via SSM

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.IAM_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.IAM_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION_KEY }}

      - name: Run scraper via SSM
        run: |
          INSTANCE_ID=${{ secrets.EC2_INSTANCE_ID }}

          aws ssm send-command \
            --targets "Key=InstanceIds,Values=$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Run portfolio-data-scrapper" \
            --parameters 'commands=[
              "BASE_DIR=/home/ec2-user",
              "LOG_DIR=$BASE_DIR/logs",
              "TMP_LOG=$LOG_DIR/scrapper.tmp.log",
              "mkdir -p $LOG_DIR",
              "cd $BASE_DIR/portfolio-data-scrapper",
              "git config --global --add safe.directory /home/ec2-user/portfolio-data-scrapper"
              "git pull origin main",
              "npm install",
              "npx playwright install chromium",
              "/usr/bin/node scrapper.js >> $TMP_LOG 2>&1",
              "timestamp=$(date -u +\"%Y-%m-%dT%H-%M-%SZ\")",
              "mv $TMP_LOG $LOG_DIR/scrapper-$timestamp.log"
            ]'
